<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RupeeRunner Dashboard</title>

<script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
body{margin:0;background:#121212;color:#fff;font-family:Montserrat}
.hidden{display:none}
.app{max-width:600px;margin:auto;padding:20px}
.card{background:#181818;border-radius:10px;padding:20px;margin-bottom:15px}
.balance{font-size:42px;font-weight:800;color:#1db954;text-align:center}
input{width:100%;padding:12px;border:none;border-radius:6px;background:#2a2a2a;color:#fff;margin-bottom:10px}
button{width:100%;padding:12px;border:none;border-radius:30px;font-weight:700;cursor:pointer}
.primary{background:#1db954;color:#000}
.secondary{background:#333;color:#aaa}
button:disabled{background:#555;color:#888}
.history-item{display:flex;justify-content:space-between;background:#222;padding:12px;border-radius:6px;margin-bottom:8px}
.badge-processing{color:#ff9f1a}
.badge-completed{color:#1db954}
.badge-rejected{color:#e91429}
</style>
</head>

<body>

<div id="login" class="app">
  <h1 style="text-align:center">RupeeRunner</h1>
  <button class="primary" onclick="login()">Login with Google</button>
</div>

<div id="dashboard" class="app hidden">

  <div class="card">
    <div id="name"></div>
    <div id="email" style="font-size:12px;color:#aaa"></div>
  </div>

  <div class="card">
    <div style="text-align:center">Balance</div>
    <div id="balance" class="balance">₹0</div>
  </div>

  <div class="card">
    <h3>Bank Details (One Time)</h3>
    <input id="bankName" placeholder="Bank Name">
    <input id="accountNo" placeholder="Account Number">
    <input id="ifsc" placeholder="IFSC Code">
    <button id="saveBankBtn" class="secondary" onclick="saveBank()">Save Bank</button>
    <div id="bankLock" class="hidden" style="color:#1db954;margin-top:10px">✔ Bank Verified</div>
  </div>

  <div class="card">
    <h3>Withdraw</h3>
    <input id="amount" type="number" placeholder="Amount">
    <button id="withdrawBtn" class="primary" onclick="withdraw()" disabled>Withdraw</button>
  </div>

  <div class="card">
    <h3>Withdraw History</h3>
    <div id="history"></div>
  </div>

  <button class="secondary" onclick="logout()">Logout</button>

</div>

<script>
const API="https://script.google.com/macros/s/AKfycbzS_P2RmYzj2dVWyUDwWYQ5VG2nn7aDSv5UKPStH3KvkFBodDQzY8J8iRjMqG_y08Cd/exec";

const ADMIN_EMAILS=[
  "project410api@gmail.com",
  "project410api2@gmail.com"
];

let currentBalance=0;
let bankSaved=false;

const auth0Client=new auth0.Auth0Client({
  domain:"dev-nil04cagtdkw1jp1.us.auth0.com",
  clientId:"Vx7V7OBG7U5k6eHxGqFigS0Vpi0TGT0F",
  authorizationParams:{redirect_uri:window.location.href}
});

async function login(){await auth0Client.loginWithRedirect()}
async function logout(){await auth0Client.logout({logoutParams:{returnTo:window.location.href}})}

async function init(){
  if(location.search.includes("code=")){
    await auth0Client.handleRedirectCallback();
    history.replaceState({},'',location.pathname);
  }
  if(!await auth0Client.isAuthenticated()) return;
  document.getElementById("login").classList.add("hidden");
  document.getElementById("dashboard").classList.remove("hidden");

  const user=await auth0Client.getUser();
  name.innerText=user.name;
  email.innerText=user.email;

  await fetch(API,{method:"POST",body:JSON.stringify({
    action:"addUser",auth0_id:user.sub,email:user.email,name:user.name
  })});

  loadProfile();
  loadHistory();
}

async function loadProfile(){
  const user=await auth0Client.getUser();
  const r=await fetch(API,{method:"POST",body:JSON.stringify({
    action:"getUserProfile",auth0_id:user.sub
  })});
  const d=await r.json();
  if(!d.profile) return;

  currentBalance=Number(d.profile.balance);
  bankSaved=d.profile.bankSaved;

  balance.innerText="₹"+currentBalance;
  withdrawBtn.disabled=!(bankSaved && currentBalance>0);

  if(bankSaved){
    bankLock.classList.remove("hidden");
    bankName.disabled=accountNo.disabled=ifsc.disabled=true;
    saveBankBtn.style.display="none";
  }
}

async function saveBank(){
  const user=await auth0Client.getUser();
  if(!bankName.value||!accountNo.value||!ifsc.value) return alert("Fill all bank details");

  await fetch(API,{method:"POST",body:JSON.stringify({
    action:"saveBank",
    auth0_id:user.sub,
    bank_name:bankName.value,
    account_no:accountNo.value,
    ifsc:ifsc.value
  })});

  bankSaved=true;
  bankLock.classList.remove("hidden");
  bankName.disabled=accountNo.disabled=ifsc.disabled=true;
  saveBankBtn.style.display="none";
  if(currentBalance>0) withdrawBtn.disabled=false;
}

async function withdraw(){
  const amt=Number(amount.value);
  if(!bankSaved) return alert("Add bank first");
  if(amt<=0) return alert("Invalid amount");
  if(amt>currentBalance) return alert("Insufficient balance");

  const user=await auth0Client.getUser();
  await fetch(API,{method:"POST",body:JSON.stringify({
    action:"withdraw",auth0_id:user.sub,amount:amt
  })});

  currentBalance-=amt;
  balance.innerText="₹"+currentBalance;
  amount.value="";
  if(currentBalance<=0) withdrawBtn.disabled=true;
  loadHistory();
}

async function loadHistory(){
  const user=await auth0Client.getUser();
  const r=await fetch(API,{method:"POST",body:JSON.stringify({
    action:"getUserWithdraws",auth0_id:user.sub
  })});
  const d=await r.json();
  history.innerHTML="";
  (d.withdraws||[]).reverse().forEach(w=>{
    history.innerHTML+=`
      <div class="history-item">
        <div>₹${w[1]}</div>
        <div class="badge-${w[3]}">${w[3]}</div>
      </div>`;
  });
}

init();
</script>
</body>
</html>
